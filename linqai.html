<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linq AI - Your Energy Questions Answered</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      color: #E0E0E0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
    }
    .chat-container-wrapper {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    .chat-header-area { padding-top: 100px; }
    .chat-page-title { font-size: 2.5rem; font-weight: 700; color: white; text-align: center; }
    .chat-page-subtitle { font-size: 1rem; text-align: center; color: #9CA3AF; margin-bottom: 1rem; }
    .chat-window { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .message-bubble { border-radius: 1rem; padding: 1rem; max-width: 75%; line-height: 1.5; }
    .message-bubble.user { align-self: flex-end; background: #007ACC; color: white; }
    .message-bubble.ai { align-self: flex-start; background: #1E293B; color: #CBD5E1; }
    .chat-input-area { padding: 1rem; border-top: 1px solid #2A2A2A; }
    .chat-input-form { display: flex; gap: 0.5rem; background: #18181B; border: 1px solid #2A2A2A; border-radius: 9999px; padding: 0.5rem 1rem; }
    .chat-input { flex: 1; background: transparent; border: none; color: white; font-size: 1rem; }
    .chat-input:focus { outline: none; }
    .send-button { background: #00BFFF; border-radius: 50%; padding: 0.5rem; display: flex; align-items: center; justify-content: center; color: white; border: none; cursor: pointer; }
    .send-button:disabled { background: #555; cursor: not-allowed; }
    .suggested-questions { padding: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
    .suggested-question-btn { padding: 0.5rem 1rem; background: #222; border: 1px solid #333; border-radius: 0.5rem; color: #aaa; cursor: pointer; }
    .suggested-question-btn:hover { background: #2a2a2a; color: #00BFFF; border-color: #00BFFF; }
  </style>
</head>
<body class="antialiased">
  <div style="height: 68px;" class="w-full bg-black border-b border-gray-800"></div>
  <div id="header-placeholder"></div>

  <div class="chat-container-wrapper px-4">
    <div class="chat-header-area">
      <h1 class="chat-page-title">Linq <span class="text-sky-400">AI</span></h1>
      <p class="chat-page-subtitle">Your Energy Questions Answered</p>
    </div>

    <div id="chat-window" class="chat-window"></div>

    <div id="suggested-questions" class="suggested-questions">
      <button class="suggested-question-btn">Future of Green Hydrogen?</button>
      <button class="suggested-question-btn">Latest on Carbon Capture?</button>
      <button class="suggested-question-btn">Oil Price Volatility Factors?</button>
      <button class="suggested-question-btn">Nuclear Energy Renaissance?</button>
    </div>

    <div class="chat-input-area">
      <form id="chat-form" class="chat-input-form">
        <input type="text" id="chat-input" class="chat-input" placeholder="Ask Linq AI..." autocomplete="off">
        <button type="submit" id="send-button" class="send-button" aria-label="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_FCx8sIkrCoQMoKm5xQIvlyAmlqptETk",
      authDomain: "linq-b27a8.firebaseapp.com",
      projectId: "linq-b27a8",
      storageBucket: "linq-b27a8.appspot.com",
      messagingSenderId: "1067901051826",
      appId: "1:1067901051826:web:44452d1339cdbe2af07aab"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const suggestedQuestionsContainer = document.getElementById('suggested-questions');

    let isSubscribed = false;
    let conversationHistory = [{ role: 'system', content: 'You are Linq AI, a helpful energy analyst.' }];

    document.addEventListener('DOMContentLoaded', () => {
      fetch('header.html')
        .then(res => res.ok ? res.text() : Promise.reject())
        .then(html => {
          document.getElementById('header-placeholder').innerHTML = html;
          auth.onAuthStateChanged(handleAuthStateChange);
        })
        .catch(() => {
          console.warn('Header failed to load.');
          updateChatUI(false);
        });

      chatForm.addEventListener('submit', handleFormSubmit);
      suggestedQuestionsContainer.addEventListener('click', handleSuggestedClick);

      addMessageToChat("I'm Linq AI â€” ask me anything about energy markets.", 'ai');
    });

    function handleAuthStateChange(user) {
      if (!user) return updateChatUI(false);
      db.collection('users').doc(user.uid).onSnapshot(doc => {
        isSubscribed = doc.exists && doc.data().isSubscribed;
        updateChatUI(true);
      });
    }

    function updateChatUI(allowInput) {
      chatInput.disabled = !allowInput;
      sendButton.disabled = !allowInput;
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      const user = auth.currentUser;
      const text = chatInput.value.trim();
      if (!user) return addMessageToChat("<a href='login.html'>Log in</a> to use Linq AI.", 'ai', true);
      if (!isSubscribed) return addMessageToChat("Upgrade to use Linq AI.", 'ai', true);
      if (!text) return;

      addMessageToChat(text, 'user');
      chatInput.value = '';

      try {
        const token = await user.getIdToken();
        const response = await fetch('https://us-central1-linq-b27a8.cloudfunctions.net/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ conversationHistory: [...conversationHistory, { role: 'user', content: text }] })
        });
        const data = await response.json();
        conversationHistory.push({ role: 'user', content: text }, { role: 'assistant', content: data.response });
        addMessageToChat(data.response, 'ai');
      } catch {
        addMessageToChat("Sorry, there was an error.", 'ai');
      }
    }

    function handleSuggestedClick(e) {
      if (e.target.classList.contains('suggested-question-btn')) {
        chatInput.value = e.target.textContent;
        chatForm.dispatchEvent(new Event('submit'));
      }
    }

    function addMessageToChat(message, type, isHtml = false) {
      const div = document.createElement('div');
      div.className = `message-bubble ${type}`;
      div.innerHTML = isHtml ? message : message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
  </script>
  <script src="headerManager.js" defer></script>
</body>
</html>
